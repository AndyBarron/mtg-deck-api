import bcrypt from 'bcrypt';
import { MONGODB_URI, PORT } from 'config';
import Koa from 'koa';
import bodyParser from 'koa-bodyparser';
import KoaRouter from 'koa-router';
import User, { USERNAME_REGEX } from 'models/User';
import mongoose from 'mongoose';
mongoose.Promise = Promise;
import validator from 'validator';

mongoose.connect(MONGODB_URI);

const app = new Koa();
const router = new KoaRouter();

router.get('/', async (ctx) => {
  ctx.body = {message: 'Hello, World!'};
});

router.post('/user', async (ctx) => {

  const { email, password, username } = ctx.request.body;

  if (!validator.isEmail(email)) {
    return ctx.throw(400, 'Invalid email address');
  }

  if (!validator.isLength(password, {min: 8})) {
    return ctx.throw(400, 'Password too short');
  }

  if (!username) {
    return ctx.throw(400, 'Missing username');
  }

  if (!USERNAME_REGEX.test(username)) {
    return ctx.throw(400, 'Invalid username');
  } else {
    console.log(USERNAME_REGEX);
    console.log(username);
    console.log(USERNAME_REGEX.test(username));
  }

  const canonicalUsername = username.toLowerCase();

  const existing = await User.findOne({ canonicalUsername });
  if (existing) {
    return ctx.throw(409, 'Username is taken');
  }

  const passwordHash = await bcrypt.hash(password, 10);

  const user = new User({
    canonicalUsername,
    email,
    passwordHash,
    username,
  });

  await user.save();

  // TODO: Generate token? (Maybe if it's specified in the request body)
  ctx.body = {};

});

router.post('/token', async (ctx) => {

  let { email } = ctx.request.body;
  const { password } = ctx.request.body;

  if (!validator.isEmail(email)) {
    ctx.throw(400, 'Invalid email address');
  }

  if (!validator.isLength(password, {min: 8})) {
    ctx.throw(400, 'Password too short');
  }

  ctx.body = {
    token: "<insert valid token here if auth succeeds>",
  };
});

app.use(async (ctx, next) => {
  try {
    await next();
  } catch (error) {
    console.error(error);
    const message = error.expose ? error.message : 'Unknown error';
    const status = error.statusCode || error.status || 500;
    ctx.status = status;
    ctx.body = {
      error: {
        message,
      },
    };
  }
});

app.use(bodyParser({
  enableTypes: ['json'],
  onerror: (error, ctx) => {
    ctx.throw('invalid request body', 400);
  },
}));
app.use(router.routes());
app.use(router.allowedMethods());

app.listen(PORT, () => console.info(`API listening on port ${PORT}`));
