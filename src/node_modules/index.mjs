import { PORT } from 'config';
import Koa from 'koa';
import bodyParser from 'koa-bodyparser';
import KoaRouter from 'koa-router';
import validator from 'validator';

const app = new Koa();
const router = new KoaRouter();

router.get('/', async (ctx) => {
  ctx.body = {message: 'Hello, World!'};
});

router.post('/token', async (ctx) => {

  let { email } = ctx.request.body;
  const { password } = ctx.request.body;

  if (!validator.isEmail(email)) {
    ctx.throw(400, 'Invalid email address');
  }

  if (!validator.isLength(password, {min: 8})) {
    ctx.throw(400, 'Password too short');
  }

  ctx.body = {
    token: "<insert valid token here if auth succeeds>",
  };
});

app.use(async (ctx, next) => {
  try {
    await next();
  } catch (error) {
    const message = error.expose ? error.message : 'Unknown error';
    const status = error.statusCode || error.status || 500;
    ctx.status = status;
    ctx.body = {
      error: {
        message,
      },
    };
  }
});

app.use(bodyParser({
  enableTypes: ['json'],
  onerror: (error, ctx) => {
    ctx.throw('invalid request body', 400);
  },
}));
app.use(router.routes());
app.use(router.allowedMethods());

app.listen(PORT, () => console.info(`API listening on port ${PORT}`));
